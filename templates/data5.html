{% extends 'base.html' %}
{% load static %}
{% block content %}
    <style>
        .chart-container {
            width: 100%;   /* Set your preferred width */
            height: 400px; /* Set your preferred height */
        }

        #heatmap {
            width: 100%;
            height: 400px;
        }

        #strategy-summary-data {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 20px;
            margin-bottom: 50px;
        }

        .charts-wrapper-hidden {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100vh;
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 50px 100px;
            overflow: hidden;
            display: none;
        }

        #charts-container {
            height: 100%;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        #charts-container::-webkit-scrollbar {
            width: 8px;
        }
        #charts-container::-webkit-scrollbar-track {
            background : #a1a1a1;
        }
        #charts-container::-webkit-scrollbar-thumb {
            background : #0569ff;
            border-radius: 10px;
            box-shadow:  0 0 6px rgba(0, 0, 0, 0.5);
        } 

        .main-panel {
            position: relative;
        }

        .page-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            z-index: 9999;
            text-align: center;
            padding-top: 15%;
        }

        .page-loader img {
            width: 200px;
        }
        
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
    <!-- partial -->
    <div class="main-panel">
        <div class="page-loader">
            <img src="{% static 'images/loader.gif' %}" alt="image">
        </div>
        
        <div id="strategy-link-div" style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; position: fixed;top: 80px;left: 290px;width: calc(100% - 320px);z-index: 99; background-color: #fff; padding: 3px;">
            <a href="#home" class="btn btn-secondary top-nav-btn" style="padding: 5px 15px;"><i class="typcn typcn-arrow-up-thick" style="font-size: 30px;"></i></a>
            <a href="#frontier" class="btn btn-secondary top-nav-btn">Frontiers</a>
            <a href="#strategy-summary" class="btn btn-secondary top-nav-btn">Strategies Summary Table</a>
            <a href="#strategy-summary-data" class="btn btn-secondary top-nav-btn">Strategies Summary</a>
            <a href="#covariance-correlation" class="btn btn-secondary top-nav-btn">Covariance Correlation</a>
        </div>
        <div class="content-wrapper" style="padding-top: 130px;" id="home">
        <p>Processing Time: {{ processing_time }}</p>
        
        <div>
           
            {% for strategy, allocations in strategy_purchase_allocations.items %}
                <a href="#{{ strategy }}" class="btn btn-secondary btn-sm">{{ strategy }}</a>
            {% endfor %}
        </div>
        <div class="row" id="frontier">
            <div class="col-lg-6 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Strategies Frontier</h4>
                    <div id="frontierScatterGraph" style="width: 100%;height:500px;"></div>
                </div>
            </div>
            </div>
            <div class="col-lg-6 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Simulations Frontier</h4>
                    <div id="heatmap" style="width: 100%;height:500px;"></div>
                </div>
            </div>
            </div>
        </div>

        <div class="row mb-4" id="strategy-summary">
            <div class="col-lg-12 strech-card">
                <div class="card">
                    <div class="card-body">
                        <h3>Strategies Summary</h3>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th class="font-weight-bold">#</th>
                                    <th class="font-weight-bold">Strategy</th>
                                    <th class="font-weight-bold">Exp Return (%)</th>
                                    <th class="font-weight-bold">Std Dev (%)</th>
                                    <th class="font-weight-bold">Sharpe Ratio</th>
                                    <th class="font-weight-bold">Sortino Ratio</th>
                                    <th class="font-weight-bold">CVaR 90% (%)</th>
                                    <th class="font-weight-bold">CVaR 95% (%)</th>
                                    <th class="font-weight-bold">CVaR 99% (%)</th>
                                    <th class="font-weight-bold">CVaR 99.9% (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for strategy in strategy_summaries %}
                                    <tr>
                                        <td class="p-2">{{ forloop.counter }}</td>
                                        <td class="p-2"><a href="#{{ strategy.strategy_id }}-summary" class="btn btn-link">{{ strategy.strategy_name }}</a></td>
                                        <td class="p-2">{{ strategy.annual_expected_return }}</td>
                                        <td class="p-2">{{ strategy.annual_standard_deviation }}</td>
                                        <td class="p-2">{{ strategy.annual_sharpe_ratio }}</td>
                                        <td class="p-2">{{ strategy.annual_sortino_ratio }}</td>
                                        <td class="p-2">{{ strategy.cvar_900 }}</td>
                                        <td class="p-2">{{ strategy.cvar_950 }}</td>
                                        <td class="p-2">{{ strategy.cvar_990 }}</td>
                                        <td class="p-2">{{ strategy.cvar_999 }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        
                    </div>
                </div>
            </div>
        </div>


        <div id="strategy-summary-data"></div>

        <div class="row" id="covariance-correlation">
            <div class="col-lg-6 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Covariance</h4>
                    <div id="covarianceHeatmap" style="width: 100%;height:500px;"></div>
                </div>
            </div>
            </div>
            <div class="col-lg-6 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">correlation Heatmap</h4>
                    <div id="correlationHeatmap" style="width: 100%;height:500px;"></div>
                </div>
            </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-12 strech-card">
                <div class="card">
                    <div class="card-body">
                        <div class="symbol-portfolio">
                            <h3>SL Risk: Portfolios Detail</h3>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th class="font-weight-bold">Key</th>
                                        <th class="font-weight-bold">Metrics Name</th>
                                        <th class="font-weight-bold">AAPL</th>
                                        <th class="font-weight-bold">CSCO</th>
                                        <th class="font-weight-bold">NFLX</th>
                                        <th class="font-weight-bold">AMD</th>
                                        <th class="font-weight-bold">CVX</th>
                                        <th class="font-weight-bold">PFE</th>
                                        <th class="font-weight-bold">MMM</th>
                                        <th class="font-weight-bold">MSFT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in symbol_portfolios_data %}
                                        <tr>
                                            <td class="p-2">{{ row.key }}</td>
                                            <td class="p-2">{{ row.metric }}</td>
                                            <td class="p-2">{{ row.AAPL|default:"N/A" }}</td>
                                            <td class="p-2">{{ row.CSCO|default:"N/A" }}</td>
                                            <td class="p-2">{{ row.NFLX|default:"N/A" }}</td>
                                            <td class="p-2">{{ row.AMD|default:"N/A" }}</td>
                                            <td class="p-2">{{ row.CVX|default:"N/A" }}</td>
                                            <td class="p-2">{{ row.PFE|default:"N/A" }}</td>
                                            <td class="p-2">{{ row.MMM|default:"N/A" }}</td>
                                            <td class="p-2">{{ row.MSFT|default:"N/A" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        
                    </div>
                </div>
            </div>
        </div>
        
        

        {% for strategy, allocations in strategy_purchase_allocations.items %}
            <div class="row mb-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <div>{{ strategy }}</div>

                            <div class="row" id="{{ strategy }}">
                                <div class="col-lg-4"></div>
                                <div class="col-lg-4">
                                    <div class="chart-container" id="chart-{{ forloop.counter }}"></div>
                            
                                    <script>
                                        var strategyTitle = '{{ strategy|escapejs }}';
                                        var chartData = {{ allocations|safe }};  // Use the pre-formatted chart data
                                        var counter = '{{ forloop.counter|escapejs }}';
        
                                        
        
                                        var chartDom = document.getElementById('chart-' + counter);
                                        var myChart = echarts.init(chartDom);
        
                                        var option = {
                                            tooltip: {
                                                trigger: 'item'
                                            },
                                            legend: {
                                                show: false
                                            },
                                            series: [
                                                {
                                                    name: 'Access From',
                                                    type: 'pie',
                                                    radius: ['40%', '70%'],
                                                    avoidLabelOverlap: false,
                                                    itemStyle: {
                                                        borderRadius: 10,
                                                        borderColor: '#fff',
                                                        borderWidth: 2
                                                    },
                                                    label: {
                                                        show: false,
                                                        position: 'center'
                                                    },
                                                    emphasis: {
                                                        label: {
                                                            show: true,
                                                            fontSize: 40,
                                                            fontWeight: 'bold'
                                                        }
                                                    },
                                                    labelLine: {
                                                        show: false
                                                    },
                                                    data: chartData
                                                }
                                            ]
                                        };
                                        
                                        myChart.setOption(option);
                                    </script>
                                </div>
                                <div class="col-lg-4"></div>
                            </div>
                            

                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

         
        <div id="chart-wrapper">
            <div id="charts-container"></div>
        </div>

        </div>


        <!-- content-wrapper ends -->
        <!-- partial:../../partials/_footer.html -->
        <footer class="footer">
            <div class="d-sm-flex justify-content-center justify-content-sm-between">
                <span class="text-center text-sm-left d-block d-sm-inline-block">Copyright © bootstrapdash.com</span>
            </div>
        </footer>
        <!-- partial -->
    </div>
        
    <script>
        // Float metrics
        const floatMetrics = new Set([
            'annual_sharpe_ratio', 'annual_sortino_ratio', 'skew', 'kurtosis',
            'daily_sharpe_ratio', 'daily_sortino_ratio', 'entropic_risk_measure_at_95',
            'ulcer_index', 'mean_absolute_deviation_ratio', 'first_lower_partial_moment_ratio',
            'value_at_risk_ratio_at_95', 'conditional_var_ratio_at_95', 'entropic_risk_measure_ratio_at_95',
            'entropic_var_ratio_at_95', 'worst_realization_ratio', 'drawdown_at_risk_ratio_at_95',
            'conditional_dar_ratio_at_95', 'calmar_ratio', 'average_drawdown_ratio',
            'entropic_dar_ratio_at_95', 'ulcer_index_ratio', 'gini_mean_difference_ratio'
        ]);

        const symboPortfolioData = document.querySelector('.symbol-portfolio');

        const strategyAllocationData = {{ strategy_allocation_data|safe }}; // Pass JSON data to JavaScript

        const strategySummaryDataContainer = document.querySelector('#strategy-summary-data');
        
        strategyAllocationData.forEach((strategyData, index) => {
            const {strategy_performances, strategy_stats_descriptives, strategy_stats_moments, strategy_stats_risk_measures, strategy_stats_ratios, strategy_purchase_allocations, strategy_current_allocations, strategy_sector_purchase_allocations, strategy_sector_current_allocations } = strategyData;

            const strategies = Object.keys(strategy_purchase_allocations);

            strategies.forEach((strategy) => {
                const purchaseAllocations = strategy_purchase_allocations[strategy];
                const currentAllocations = strategy_current_allocations[strategy];
                const sectorAllocations = strategy_sector_purchase_allocations[strategy];
                const sectorCurrentAllocations = strategy_sector_current_allocations[strategy];
                
                // Create link list
                const linkTag = document.createElement('a');
                linkTag.href = `#${strategy}-summary`;
                linkTag.innerText = formatStrategyName(strategy);
                linkTag.classList = 'btn btn-secondary';
                document.getElementById('strategy-link-div').appendChild(linkTag)

                // Create a parent div for both charts
                const parentDiv = document.createElement('div');
                parentDiv.id = `${strategy}`;
                parentDiv.style.display = 'grid';
                parentDiv.style.gridTemplateColumns = 'repeat(2, 1fr)';
                parentDiv.style.gridGap = '20px';
                parentDiv.style.backgroundColor = '#fff';
                parentDiv.style.padding = '30px';
                parentDiv.classList = 'strategy-summary-row';
                document.getElementById('charts-container').appendChild(parentDiv);
                

                const titleDiv = document.createElement('div');
                titleDiv.setAttribute('id', `${strategy}`);
                titleDiv.style.gridColumnStart = '1';
                titleDiv.style.gridColumnEnd = '3';
                titleDiv.style.display = 'flex';
                titleDiv.style.justifyContent = 'space-between';
                titleDiv.style.alignItems = 'center';
                const strategyTitle = document.createElement('h2');
                strategyTitle.innerText = `${formatStrategyName(strategy)}`;
                const strategyPopupCloseBtn = document.createElement('button');
                strategyPopupCloseBtn.classList = 'btn btn-inverse-danger strategy-popup-close-btn';
                strategyPopupCloseBtn.innerText = 'X';
                titleDiv.append(strategyTitle);
                titleDiv.append(strategyPopupCloseBtn);
                parentDiv.append(titleDiv);

                const sectionNavDiv = document.createElement('div')
                sectionNavDiv.style.display = 'flex';
                sectionNavDiv.style.gap = '10px';
                sectionNavDiv.style.gridColumnStart = '1';
                sectionNavDiv.style.gridColumnEnd = '3';
                sectionNavDiv.style.position = 'sticky';
                sectionNavDiv.style.top = '30px';
                sectionNavDiv.style.backgroundColor = '#fff';
                sectionNavDiv.style.zIndex = '9';
                parentDiv.append(sectionNavDiv);

                const sectionTopLink = document.createElement('a');
                sectionTopLink.href = `#${strategy}`;
                sectionTopLink.innerHTML = `<i class="typcn typcn-arrow-up-thick" style="font-size: 15px;"></i>`;
                sectionTopLink.classList = 'btn btn-outline-info btn-fw p-2';
                sectionNavDiv.append(sectionTopLink);

                // Prepare stock data
                const stockData = purchaseAllocations.map(item => ({ value: item.value, name: item.name }));
                // Use a unique identifier for the stock chart
                createPieChart(parentDiv, strategy, `${index}-stock`, "Training Allocation: Stocks", stockData, '');
                const strategySummaryDataRow = document.createElement('div');
                strategySummaryDataRow.setAttribute('id', `${strategy}-summary`);
                strategySummaryDataRow.style.display = 'flex';
                strategySummaryDataRow.style.flexDirection = 'row-reverse';
                strategySummaryDataRow.style.justifyContent = 'space-between';
                strategySummaryDataRow.style.alignItems = 'center';
                strategySummaryDataRow.style.backgroundColor = '#fff';
                strategySummaryDataRow.style.padding = '20px';
                strategySummaryDataRow.style.cursor = 'pointer';
                strategySummaryDataRow.style.position = 'relative';
                strategySummaryDataContainer.append(strategySummaryDataRow);
                createPieChart(strategySummaryDataRow, formatSentence(strategy), `${index}-stock-summary`, "", stockData, 'fixed');

                const strategyDetailLink = document.createElement('a');
                strategyDetailLink.setAttribute('data-id', strategy);
                strategyDetailLink.innerText = "View Detail";
                strategyDetailLink.classList = 'btn btn-outline-secondary btn-fw p-2 strategy-popup-view-btn';
                strategyDetailLink.style.position = 'absolute';
                strategyDetailLink.style.right = '20px';
                strategyDetailLink.style.top = '20px';
                strategySummaryDataRow.appendChild(strategyDetailLink);
                
                // Prepare sector data
                const sectorData = sectorAllocations.map(item => ({ value: item.value, name: item.name }));
                // Use a unique identifier for the sector chart
                createPieChart(parentDiv, strategy, `${index}-sector`, "Training Allocation: Sectors", sectorData, '');


                // Create and append the tables
                let tableId = `${strategy}-${index}-performance`;
                const performanceTable = createPerformanceTable('Strategy Performance', tableId, strategy_performances[strategy]);
                parentDiv.appendChild(performanceTable);
                createSectionLinkAndAppend(tableId, sectionNavDiv, 'Strategy Performance');
                const performanceTableSummary = createPerformanceTable(strategy.replace('_', ' '), tableId+"-summary", strategy_performances[strategy]);
                strategySummaryDataRow.append(performanceTableSummary);

                tableId = `${strategy}-${index}-descriptive`;
                const statsDescriptiveTable = createPerformanceTable('PL Risk: Descriptive Stats', tableId, strategy_stats_descriptives[strategy]);
                parentDiv.appendChild(statsDescriptiveTable);
                createSectionLinkAndAppend(tableId, sectionNavDiv, 'PL Risk: Descriptive Stats');

                tableId = `${strategy}-${index}-stats-moment`;
                const statsMomentTable = createPerformanceTable('PL Risk: Moment Stats', tableId, strategy_stats_moments[strategy]);
                parentDiv.appendChild(statsMomentTable);
                createSectionLinkAndAppend(tableId, sectionNavDiv, 'PL Risk: Moment Stats');

                tableId = `${strategy}-${index}-risk-measures`;
                const statsMeasureTable = createPerformanceTable('PL Risk: Measures', tableId, strategy_stats_risk_measures[strategy]);
                parentDiv.appendChild(statsMeasureTable);
                createSectionLinkAndAppend(tableId, sectionNavDiv, 'PL Risk: Measures');

                tableId = `${strategy}-${index}-stats-ratio`;
                const statsRatioTable = createPerformanceTable('PL Risk: Ratio Stats', tableId, strategy_stats_ratios[strategy]);
                parentDiv.appendChild(statsRatioTable);
                createSectionLinkAndAppend(tableId, sectionNavDiv, 'PL Risk: Ratio Stats');

                // Symbol Data
                const clonedPortfolioData = symboPortfolioData.cloneNode(true); 
                clonedPortfolioData.setAttribute('id', `${strategy}-${index}-symbol-portfolio`);
                clonedPortfolioData.style.gridColumnStart = 1;
                clonedPortfolioData.style.gridColumnEnd = 3;
                console.log(clonedPortfolioData);
                parentDiv.appendChild(clonedPortfolioData);
                // Symbol Data Link
                const sectionTopSymbolLink = document.createElement('a');
                sectionTopSymbolLink.href = `#${strategy}-${index}-symbol-portfolio`;
                sectionTopSymbolLink.innerHTML = 'SL Risk: Portfolio';
                sectionTopSymbolLink.classList = 'btn btn-outline-info btn-fw p-2';
                sectionNavDiv.append(sectionTopSymbolLink);

                // TESTING DATA - ACCESS RESTRICTED
                const testingDataContainer = document.createElement('div');
                testingDataContainer.style.gridColumnStart = '1';
                testingDataContainer.style.gridColumnEnd = '3';
                const testingDataContainerHeader = document.createElement('h3');
                testingDataContainerHeader.setAttribute('id', `${strategy}-testing-data`)
                testingDataContainerHeader.innerText = 'Testing Data';
                testingDataContainer.appendChild(testingDataContainerHeader);
                // Testing Data section Nav
                const testingDataNav = document.createElement('div');
                testingDataContainer.appendChild(testingDataNav);

                const testingDataInnerContainer = document.createElement('div');
                testingDataInnerContainer.style.display = 'grid';
                testingDataInnerContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
                testingDataInnerContainer.style.gridGap = '20px';
                testingDataInnerContainer.style.margin = '30px 0';
                testingDataInnerContainer.style.position = 'relative';
                // Lock layer
                const testingDataLockContainer = document.createElement('div');
                testingDataLockContainer.style.position = 'absolute';
                testingDataLockContainer.style.left = '0px';
                testingDataLockContainer.style.top = '0px';
                testingDataLockContainer.style.width = '100%';
                testingDataLockContainer.style.height = '100%';
                testingDataLockContainer.style.zIndex = 9;
                testingDataLockContainer.style.border = '1px solid rgba(0, 0, 0, 0.3)';
                testingDataLockContainer.style.borderRadius = '5px';
                testingDataLockContainer.style.backdropFilter = 'blur(10px)';
                testingDataLockContainer.style.background = 'rgba(255, 255, 255, 0.2)'; 
                testingDataLockContainer.style.display = 'flex'; 
                testingDataLockContainer.style.justifyContent = 'center'; 
                testingDataLockContainer.style.alignItems = 'center'; 
                testingDataInnerContainer.appendChild(testingDataLockContainer);

                createAccessUnlockInputForm(testingDataLockContainer, sectionNavDiv, strategy);

                testingDataContainer.appendChild(testingDataInnerContainer);
                parentDiv.appendChild(testingDataContainer);

                // Prepare current stock data
                const currentStockData = currentAllocations.map(item => ({ value: item.value, name: item.name }));
                // Use a unique identifier for the stock chart
                createPieChart(testingDataInnerContainer, strategy, `${index}-current-stock`, "Testing Allocation:Stocks", currentStockData, '');
                
                const testingDataLink = document.createElement('a');
                testingDataLink.href = `#chart-sector-${strategy}-${index}-current-stock`;
                testingDataLink.innerHTML = 'Testing Allocation:Stocks';
                testingDataLink.classList = 'btn btn-outline-success btn-fw p-2';
                testingDataNav.append(testingDataLink);

                // Prepare sector data
                const sectorCurrentData = sectorCurrentAllocations.map(item => ({ value: item.value, name: item.name }));
                // Use a unique identifier for the sector chart
                createPieChart(testingDataInnerContainer, strategy, `${index}-current-sector`, "Testing Allocation:Sectors", sectorCurrentData, '');



            });


        });


        // Function to create a table for strategy performances
        function createPerformanceTable(title, tableId, performanceData) {
            const container = document.createElement('div');
            if(title == 'Strategy Performance') {
                container.style.gridColumnStart = 1;
                container.style.gridColumnEnd = 3;
            }
            container.setAttribute('id', tableId);
    
            // Create and append the title
            const titleElement = document.createElement('h3');
            titleElement.innerHTML = `<strong>${formatStrategyName(title)}</strong>`; // Set the title text
            container.appendChild(titleElement);
            
            // Create a table element
            const table = document.createElement('table');
            table.classList = 'table table-striped';
            table.style.width = '100%';
            table.style.marginBottom = '20px'; // Space between the table and charts

            // Create a table header
            const headerRow = document.createElement('tr');
            const headers = ['Metric', 'Value'];
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.innerText = headerText;
                th.style.border = '1px solid #ddd';
                th.style.padding = '8px';
                th.style.textAlign = 'left';
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            function formatPercentage(value) {
                return typeof value === 'number' ? (value * 100).toFixed(2) + '%' : value;
            }

            // Populate the table with performance data
            for (const [metric, value] of Object.entries(performanceData)) {
                const row = document.createElement('tr');
                const tdMetric = document.createElement('td');
                tdMetric.style.width = '70%';
                const tdValue = document.createElement('td');

                tdMetric.innerText = formatStrategyName(metric);

                // Check if the value is an array and handle accordingly
                if (Array.isArray(value)) {
                    const firstItem = value[0];
                    tdMetric.innerText += ` (${firstItem.index.replace('^', '')})`;
                    tdValue.innerText = formatPercentage(firstItem.value);
                } else if (floatMetrics.has(metric)) {
                    tdValue.innerText = value.toFixed(2) || '-';
                }
                else {
                    tdValue.innerText = formatPercentage(value) || '-';
                }
                tdMetric.style.border = '1px solid #ddd';
                tdValue.style.border = '1px solid #ddd';
                tdMetric.style.padding = '8px';
                tdValue.style.padding = '8px';

                row.appendChild(tdMetric);
                row.appendChild(tdValue);
                table.appendChild(row);
            }

            const tableContainer = document.createElement('div');
            tableContainer.classList = 'table-responsive';
            tableContainer.appendChild(table);

            // Append the table to the container
            container.appendChild(tableContainer);
            
            return container;
        }

        function createPieChart(parentDiv, strategy, index, title, data, chartWidth) {
            let widthValue = chartWidth == 'fixed' ? '400px' : '100%';
            // Create child div for the sector allocation chart
            const sectorChartDiv = document.createElement('div');
            sectorChartDiv.id = `chart-sector-${strategy}-${index}`;
            sectorChartDiv.style.width = widthValue;
            sectorChartDiv.style.height = '500px';
            parentDiv.appendChild(sectorChartDiv);
            

            // Create the sector allocation chart using the provided pie chart option
            const sectorChart = echarts.init(document.getElementById(sectorChartDiv.id));
            const sectorOption = {
                title: {
                    text: title,
                    left: 'center'
                },
                tooltip: { trigger: 'item' },
                legend: { show: false },
                series: [{
                    name: 'Sector Allocation',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        position: 'outside',
                        formatter: '{b}: ({d}%)',
                    },
                    labelLine: {
                        show: true
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold'
                        },
                        labelLine: {
                            show: false
                        },
                    },
                    data: data
                }]
            };
            sectorChart.setOption(sectorOption);

        }

        function createSectionLinkAndAppend(tableId, sectionNavDiv, text) {
            const sectionNavLink = document.createElement('a')
            sectionNavLink.href = '#' + tableId;
            sectionNavLink.innerText = text;
            sectionNavLink.classList = 'btn btn-outline-info btn-fw p-2';
            sectionNavDiv.appendChild(sectionNavLink);
        }

        
        // Handle popups
        const strategiesDetailChartsContainer = document.querySelector('#chart-wrapper');
        const strategiesDetailChartRows = document.querySelectorAll('.strategy-summary-row');
        const strategyPopupViewBtns = document.querySelectorAll('.strategy-popup-view-btn');
        const strategyPopupCloseBtns = document.querySelectorAll('.strategy-popup-close-btn');

        strategiesDetailChartRows.forEach((chartRow) => {
            chartRow.style.display = 'none';
        })

        strategiesDetailChartsContainer.classList.add('charts-wrapper-hidden')

        strategyPopupViewBtns.forEach((btn) => {
            btn.addEventListener('click', () => {
                let summaryId = btn.getAttribute('data-id');
                document.getElementById(summaryId).style.display = 'grid';
                strategiesDetailChartsContainer.style.display = 'block';
                document.documentElement.style.overflow = 'hidden';
            })
        })

        strategyPopupCloseBtns.forEach((btn) => {
            btn.addEventListener('click', () => {
                btn.parentElement.parentElement.style.display = 'none';
                strategiesDetailChartsContainer.style.display = 'none';
                document.documentElement.style.overflow = 'auto';
            })
        })
        
        
        var heatMapDom = document.getElementById('heatmap');
        var heatMapChart = echarts.init(heatMapDom);

        // Data for the chart
        var frontier_runs_x = {{ frontier_runs_x|safe }};
        var frontier_runs_y = {{ frontier_runs_y|safe }};
        var frontier_positions_random_x = {{ frontier_positions_random_x|safe }};
        var frontier_positions_random_y = {{ frontier_positions_random_y|safe }};

        var heatMapOption = {
            tooltip: {
                trigger: 'axis',
            },
            xAxis: {
                name: 'Expected Return (%)',
                type: 'value',
                min: 0,
                max: 'dataMax',
                boundaryGap: [0.1, 0.1],
                scale: true
            },
            yAxis: {
                name: 'Risk (Volatility) (%)',
                type: 'value',
                min: 0, 
                max: 'dataMax', 
                boundaryGap: [0.05, 0.05],
                scale: true
            },
            series: [
                {
                    name: 'Efficient Frontier',
                    type: 'line',
                    data: frontier_runs_x.map(function (x, i) {
                        return [x, frontier_runs_y[i]];
                    }),
                    lineStyle: {
                        color: '#525252',
                        width: 3
                    },
                    symbol: 'none' // To remove the symbols on line points
                },
                {
                    name: 'Random Positions',
                    type: 'scatter',
                    data: frontier_positions_random_x.map(function (x, i) {
                        return [x, frontier_positions_random_y[i]];
                    }),
                    itemStyle: {
                        color: '#ff0000'
                    },
                    symbolSize: 8
                }
            ]
        };

        // Set the option and display the chart
        heatMapChart.setOption(heatMapOption);

    
        var frontierRuns = {{ frontier_runs|safe }};
        var frontierPositions = {{ frontier_positions|safe }};
        
        var frontierScatterGraph = echarts.init(document.getElementById('frontierScatterGraph'));

        var frontierOption = {
            tooltip: {
                trigger: 'axis'
            },
            xAxis: {
                name: 'Risk (%)',
                type: 'value',
                min: 0,
                max: 'dataMax',
                boundaryGap: [0.1, 0.1],
                axisLabel: {
                    formatter: function (value) {
                        return (value * 100).toFixed(2) + '%';  // Convert to percentage and format to 2 decimals
                    },
                    interval: 0.01  // Set interval to 1% (0.01 in decimal form)
                },
                scale: true  // Ensure scaling adjusts to the data
            },
            yAxis: {
                name: 'Return (%)',
                type: 'value',
                min: 0, 
                max: 'dataMax', 
                boundaryGap: [0.05, 0.05],
                axisLabel: {
                    formatter: function (value) {
                        return (value * 100).toFixed(2) + '%';  // Convert to percentage and format to 2 decimals
                    },
                    interval: 0.01  // Set interval to 1% (0.01 in decimal form)
                },
                scale: true  // Ensure scaling adjusts to the data
            },
            series: [
                {
                    name: 'Efficient Frontier',
                    type: 'line',
                    data: frontierRuns.x.map(function (val, index) {
                        return [val, frontierRuns.y[index]];
                    }),
                    smooth: true,
                    lineStyle: {
                        color: '#525252',
                        width: 2
                    },
                    itemStyle: {
                        color: '#525252'
                    },
                    z: 1
                },
                {
                    name: 'Strategies',
                    type: 'scatter',
                    data: frontierPositions.x.map(function (val, index) {
                        return [val, frontierPositions.y[index]];
                    }),
                    itemStyle: {
                        color: '#52912a'
                    },
                    symbolSize: 10,
                    label: {
                        show: true,
                        formatter: function (params) {
                            return formatSentence(frontierPositions.strategies[params.dataIndex]);
                        },
                        position: 'top',
                        color: 'black',
                        fontSize: 12,
                        backgroundColor: '#fff',
                        borderColor: '#000',
                        borderWidth: 1,
                        padding: [2, 4]
                    },
                    z: 9
                }
            ]
        };

        // Use the specified chart configuration and data
        frontierScatterGraph.setOption(frontierOption);

        // Covariance heatmap
        var covarianceStockSymbols = {{ covariance_stock_symbols|safe }};
        var covarianceHeatmapData = {{ covariance_heatmap_data|safe }};

        // Adjust the heatmap data for the reversed Y-axis
        var adjustedCovarianceHeatmapData = covarianceHeatmapData.map(function (item) {
            return [item[0], covarianceStockSymbols.length - 1 - item[1], item[2]];
        });
        

        var covarianceHeatmapDom = document.getElementById('covarianceHeatmap');
        var covarianceHeatmap = echarts.init(covarianceHeatmapDom);
        var covarianceHeatmapOption;

        covarianceHeatmapOption = {
            tooltip: {
                position: 'top'
            },
            xAxis: {
                type: 'category',
                data: covarianceStockSymbols,
                splitArea: {
                    show: true
                }
            },
            yAxis: {
                type: 'category',
                data: covarianceStockSymbols.slice().reverse(),
                splitArea: {
                    show: true
                }
            },
            visualMap: {
                min: -10,
                max: 10,
                calculable: true,
                orient: 'vertical',
                left: 'right',
                top: 'center',
                inRange: {
                    color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
                }
            },
            series: [{
                name: 'Covariance',
                type: 'heatmap',
                data: covarianceHeatmapData,
                label: {
                    show: true,
                    formatter: function(params) {
                        let value = Array.isArray(params.value) ? params.value[2] : params.value;
                        return value !== null && value !== undefined ? value.toFixed(2) : '';
                    }
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };

        covarianceHeatmap.setOption(covarianceHeatmapOption);


        // Correlation heatmap
        var correlationStockSymbols = {{ correlation_stock_symbols|safe }};
        var correlationHeatmapData = {{ correlation_heatmap_data|safe }};

        var adjustedCorrelationHeatmapData = correlationHeatmapData.map(function (item) {
            return [item[0], correlationStockSymbols.length - 1 - item[1], item[2]];
        });

        var correlationHeatmapDom = document.getElementById('correlationHeatmap');
        var correlationHeatmap = echarts.init(correlationHeatmapDom);
        var correlationHeatmapOption;

        correlationHeatmapOption = {
            tooltip: {
                position: 'top'
            },
            xAxis: {
                type: 'category',
                data: correlationStockSymbols,
                splitArea: {
                    show: true
                }
            },
            yAxis: {
                type: 'category',
                data: correlationStockSymbols.slice().reverse(),
                splitArea: {
                    show: true
                }
            },
            visualMap: {
                min: -100,
                max: 100,
                calculable: true,
                orient: 'vertical',
                left: 'right',
                top: 'center',
                inRange: {
                    color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
                }
            },
            series: [{
                name: 'Covariance',
                type: 'heatmap',
                data: adjustedCorrelationHeatmapData,
                label: {
                    show: true,
                    formatter: function(params) {
                        let value = Array.isArray(params.value) ? params.value[2] : params.value;
                        return value !== null && value !== undefined ? value.toFixed(2) : '';
                    }
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };

        correlationHeatmap.setOption(correlationHeatmapOption);


        function formatSentence(text) {
            return text
                .replace(/_/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Capitalize first letter of each word
                .join(' ');
        }


        function formatStrategyName(text) {
            // Remove 'annual_' prefix if present
            if (text.startsWith('annual_')) {
                text = text.substring(7);  // Remove 'annual_' (length of 7 characters)
            }

            text = text.replace(/_/g, ' ').replace(/\b\w/g, function(match) {
                return match.toUpperCase();
            });

            text = text.replace(/Cvar/i, 'CVaR');

            if (text.toLowerCase() === 'hrp') {
                text = 'HRP';
            }

            return text;
        }


        function createAccessUnlockInputForm(testingDataLockContainer, sectionNavDiv, strategy) {
            // Hardcoded password
            const hardcodedPassword = 'password123';

            // Create the wrapper div
            var wrapperDiv = document.createElement('div');

            // Create the input field
            var inputField = document.createElement('input');
            inputField.type = 'password';  
            inputField.placeholder = 'Enter password to access...';
            inputField.style.marginBottom = '10px'; 
            inputField.style.padding = '10px';
            inputField.style.border = '1px solid rgba(0, 0, 0, 0.3)';
            inputField.style.borderRadius = '5px';
            inputField.style.width = '200px';
            inputField.style.marginRight = '15px';

            // Create the button
            var submitButton = document.createElement('button');
            submitButton.innerText = 'Unlock';
            submitButton.style.padding = '10px 20px';
            submitButton.style.border = 'none';
            submitButton.style.backgroundColor = '#007bff';
            submitButton.style.color = 'white';
            submitButton.style.borderRadius = '5px';
            submitButton.style.cursor = 'pointer';

            const sectionTopTestingLink = document.createElement('a');
            sectionTopTestingLink.href = `#${strategy}-testing-data`;
            sectionTopTestingLink.innerText = 'Testing Data';
            sectionTopTestingLink.classList = 'btn btn-outline-success btn-fw p-2';
            sectionNavDiv.append(sectionTopTestingLink);

            
            wrapperDiv.appendChild(inputField);
            wrapperDiv.appendChild(submitButton);

            // Append the wrapper div to the testingDataLockContainer
            testingDataLockContainer.appendChild(wrapperDiv);

            // Add event listener for the button click
            submitButton.addEventListener('click', function() {
                var userInput = inputField.value;  // Get the input value

                // Check if the input is empty
                if (userInput.trim() === '') {
                    alert('Please enter a password.');
                } else {
                    if (userInput === hardcodedPassword) {
                        testingDataLockContainer.remove();
                    } else {
                        alert('Incorrect password. Try again.');
                    }
                }
            });
        }

       
    </script>

{% endblock content %}